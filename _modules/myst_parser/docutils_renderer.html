
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>myst_parser.docutils_renderer</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/translations.js"></script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="shortcut icon" href="../../_static/logo-square.svg"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="zh_CN">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo-wide.svg" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../sphinx/intro.html">
   Get started with MyST in Sphinx
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MyST 语法
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../syntax/syntax.html">
   The MyST Syntax Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../syntax/optional.html">
   Optional MyST Syntaxes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../syntax/reference.html">
   MyST Syntax Reference
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  主题指南
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../explain/index.html">
   Background and explanation
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../sphinx/index.html">
   MyST with Sphinx
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../sphinx/use.html">
     Sphinx extension usage guide
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../sphinx/roles-and-directives.html">
     Special roles and directives
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../sphinx/reference.html">
     Sphinx configuration options
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../sphinx/faq.html">
     Common errors and questions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../api/index.html">
   MyST-Parser Python API
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/parsers.html">
     Parse MyST Markdown
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/renderers.html">
     Render outputs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/reference.html">
     API Reference
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../develop/index.html">
   Contribute to MyST
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../develop/contributing.html">
     Contributing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../develop/architecture.html">
     The MyST implementation architecture
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../develop/test_infrastructure.html">
     Testing Infrastructure
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  关于
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../examples/index.html">
   Example pages
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../examples/wealth_dynamics_rst.html">
     Wealth Distribution Dynamics in rST
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../examples/wealth_dynamics_md.html">
     Wealth Distribution Dynamics in MyST
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../develop/_changelog.html">
   Changelog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/executablebooks/myst-parser">
   GitHub 仓库
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <h1>myst_parser.docutils_renderer 源代码</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">jinja2</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">docutils.frontend</span> <span class="kn">import</span> <span class="n">OptionParser</span>
<span class="kn">from</span> <span class="nn">docutils.languages</span> <span class="kn">import</span> <span class="n">get_language</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Directive</span><span class="p">,</span> <span class="n">DirectiveError</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Parser</span> <span class="k">as</span> <span class="n">RSTParser</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">directives</span><span class="p">,</span> <span class="n">roles</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst.directives.misc</span> <span class="kn">import</span> <span class="n">Include</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst.languages</span> <span class="kn">import</span> <span class="n">get_language</span> <span class="k">as</span> <span class="n">get_language_rst</span>
<span class="kn">from</span> <span class="nn">docutils.statemachine</span> <span class="kn">import</span> <span class="n">StringList</span>
<span class="kn">from</span> <span class="nn">docutils.transforms.components</span> <span class="kn">import</span> <span class="n">Filter</span>
<span class="kn">from</span> <span class="nn">docutils.utils</span> <span class="kn">import</span> <span class="n">Reporter</span><span class="p">,</span> <span class="n">new_document</span>
<span class="kn">from</span> <span class="nn">markdown_it</span> <span class="kn">import</span> <span class="n">MarkdownIt</span>
<span class="kn">from</span> <span class="nn">markdown_it.common.utils</span> <span class="kn">import</span> <span class="n">escapeHtml</span>
<span class="kn">from</span> <span class="nn">markdown_it.renderer</span> <span class="kn">import</span> <span class="n">RendererProtocol</span>
<span class="kn">from</span> <span class="nn">markdown_it.token</span> <span class="kn">import</span> <span class="n">Token</span>
<span class="kn">from</span> <span class="nn">markdown_it.tree</span> <span class="kn">import</span> <span class="n">SyntaxTreeNode</span>

<span class="kn">from</span> <span class="nn">myst_parser.mocking</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MockIncludeDirective</span><span class="p">,</span>
    <span class="n">MockingError</span><span class="p">,</span>
    <span class="n">MockInliner</span><span class="p">,</span>
    <span class="n">MockRSTParser</span><span class="p">,</span>
    <span class="n">MockState</span><span class="p">,</span>
    <span class="n">MockStateMachine</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.html_to_nodes</span> <span class="kn">import</span> <span class="n">html_to_nodes</span>
<span class="kn">from</span> <span class="nn">.parse_directives</span> <span class="kn">import</span> <span class="n">DirectiveParsingError</span><span class="p">,</span> <span class="n">parse_directive_text</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">is_external_url</span>


<div class="viewcode-block" id="make_document"><a class="viewcode-back" href="../../api/reference.html#myst_parser.docutils_renderer.make_document">[文档]</a><span class="k">def</span> <span class="nf">make_document</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="s2">&quot;notset&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">document</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a new docutils document.&quot;&quot;&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">components</span><span class="o">=</span><span class="p">(</span><span class="n">RSTParser</span><span class="p">,))</span><span class="o">.</span><span class="n">get_default_values</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_document</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span></div>


<span class="n">REGEX_DIRECTIVE_START</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[\s]{0,3}([`]{3,10}|[~]{3,10}|[:]{3,10})\{&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Retrieve the initial line of a token.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;map&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;token map not set: </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore[index]</span>


<div class="viewcode-block" id="DocutilsRenderer"><a class="viewcode-back" href="../../api/reference.html#myst_parser.docutils_renderer.DocutilsRenderer">[文档]</a><span class="k">class</span> <span class="nc">DocutilsRenderer</span><span class="p">(</span><span class="n">RendererProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A markdown-it-py renderer to populate (in-place) a `docutils.document` AST.</span>

<span class="sd">    Note, this render is not dependent on Sphinx.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__output__</span> <span class="o">=</span> <span class="s2">&quot;docutils&quot;</span>

<div class="viewcode-block" id="DocutilsRenderer.__init__"><a class="viewcode-back" href="../../api/reference.html#myst_parser.docutils_renderer.DocutilsRenderer.__init__">[文档]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">MarkdownIt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load the renderer (called by ``MarkdownIt``)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;render_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;render_children&quot;</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">setup_render</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Setup the renderer with per render variables.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;document&quot;</span><span class="p">,</span> <span class="n">make_document</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;current_node&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="p">:</span> <span class="n">Reporter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">reporter</span>
        <span class="c1"># note there are actually two possible language modules:</span>
        <span class="c1"># one from docutils.languages, and one from docutils.parsers.rst.languages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language_module_rst</span><span class="p">:</span> <span class="n">ModuleType</span> <span class="o">=</span> <span class="n">get_language_rst</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">language_code</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_level_to_elem</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sphinx_env</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the sphinx env, if using Sphinx.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">create_warning</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">line</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">append_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;myst&quot;</span><span class="p">,</span>
        <span class="n">subtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">system_message</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate a warning, logging if it is necessary.</span>

<span class="sd">        Note this is overridden in the ``SphinxRenderer``,</span>
<span class="sd">        to handle suppressed warning types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="n">line</span><span class="p">}</span> <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">msg_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">append_to</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg_node</span>

    <span class="k">def</span> <span class="nf">_render_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Render the tokens.&quot;&quot;&quot;</span>
        <span class="c1"># propagate line number down to inline elements</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">map</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># For docutils we want 1 based line numbers (not 0)</span>
            <span class="n">token</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">token_child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">token_child</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">map</span>

        <span class="c1"># nest tokens</span>
        <span class="n">node_tree</span> <span class="o">=</span> <span class="n">SyntaxTreeNode</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="c1"># move footnote definitions to env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_env</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;foot_refs&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">node_tree</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">include_self</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">new_children</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;footnote_reference&quot;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">md_env</span><span class="p">[</span><span class="s2">&quot;foot_refs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

            <span class="n">node</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">new_children</span>

        <span class="c1"># render</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node_tree</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="c1"># skip hidden?</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;render_</span><span class="si">{</span><span class="n">child</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;render_</span><span class="si">{</span><span class="n">child</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">](</span><span class="n">child</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No render method for: </span><span class="si">{</span><span class="n">child</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="n">token_line</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;render&quot;</span><span class="p">,</span>
                    <span class="n">append_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
                <span class="p">)</span>

<div class="viewcode-block" id="DocutilsRenderer.render"><a class="viewcode-back" href="../../api/reference.html#myst_parser.docutils_renderer.DocutilsRenderer.render">[文档]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">options</span><span class="p">,</span> <span class="n">md_env</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">document</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run the render on a token stream.</span>

<span class="sd">        :param tokens: list on block tokens to render</span>
<span class="sd">        :param options: params of parser instance</span>
<span class="sd">        :param md_env: the markdown-it environment sandbox associated with the tokens,</span>
<span class="sd">            containing additional metadata like reference info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_render</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">md_env</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_render_tokens</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>

        <span class="c1"># log warnings for duplicate reference definitions</span>
        <span class="c1"># &quot;duplicate_refs&quot;: [{&quot;href&quot;: &quot;ijk&quot;, &quot;label&quot;: &quot;B&quot;, &quot;map&quot;: [4, 5], &quot;title&quot;: &quot;&quot;}],</span>
        <span class="k">for</span> <span class="n">dup_ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;duplicate_refs&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Duplicate reference definition: </span><span class="si">{</span><span class="n">dup_ref</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">dup_ref</span><span class="p">[</span><span class="s2">&quot;map&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;ref&quot;</span><span class="p">,</span>
                <span class="n">append_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_footnotes&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span>

        <span class="c1"># we don&#39;t use the foot_references stored in the env</span>
        <span class="c1"># since references within directives/roles will have been added after</span>
        <span class="c1"># those from the initial markdown parse</span>
        <span class="c1"># instead we gather them from a walk of the created document</span>
        <span class="n">foot_refs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">refnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">footnote_reference</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">refnode</span><span class="p">[</span><span class="s2">&quot;refname&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">foot_refs</span><span class="p">:</span>
                <span class="n">foot_refs</span><span class="p">[</span><span class="n">refnode</span><span class="p">[</span><span class="s2">&quot;refname&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">foot_refs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;myst_footnote_transition&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;footnotes&quot;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">footref</span> <span class="ow">in</span> <span class="n">foot_refs</span><span class="p">:</span>
            <span class="n">foot_ref_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_env</span><span class="p">[</span><span class="s2">&quot;foot_refs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">footref</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">foot_ref_tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Multiple footnote definitions found for label: &#39;</span><span class="si">{</span><span class="n">footref</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                    <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;footnote&quot;</span><span class="p">,</span>
                    <span class="n">append_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">foot_ref_tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No footnote definitions found for label: &#39;</span><span class="si">{</span><span class="n">footref</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                    <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;footnote&quot;</span><span class="p">,</span>
                    <span class="n">append_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">render_footnote_reference</span><span class="p">(</span><span class="n">foot_ref_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_document_wordcount</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span></div>

    <span class="k">def</span> <span class="nf">add_document_wordcount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add the wordcount, generated by the ``mdit_py_plugins.wordcount_plugin``.&quot;&quot;&quot;</span>

        <span class="n">wordcount_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wordcount&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wordcount_metadata</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># save the wordcount to the sphinx BuildEnvironment metadata</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;wordcount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wordcount_metadata</span>

        <span class="c1"># now add the wordcount as substitution definitions,</span>
        <span class="c1"># so we can reference them in the document</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;words&quot;</span><span class="p">,</span> <span class="s2">&quot;minutes&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">wordcount_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">substitution_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">substitution_definition</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">substitution_node</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
            <span class="n">substitution_node</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wordcount-</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_substitution_def</span><span class="p">(</span><span class="n">substitution_node</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;wordcount-</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DocutilsRenderer.nested_render_text"><a class="viewcode-back" href="../../api/reference.html#myst_parser.docutils_renderer.DocutilsRenderer.nested_render_text">[文档]</a>    <span class="k">def</span> <span class="nf">nested_render_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Render unparsed text.&quot;&quot;&quot;</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">text</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_env</span><span class="p">)</span>

        <span class="c1"># remove front matter</span>
        <span class="k">if</span> <span class="n">tokens</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;front_matter&quot;</span><span class="p">:</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_render_tokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span></div>

<div class="viewcode-block" id="DocutilsRenderer.current_node_context"><a class="viewcode-back" href="../../api/reference.html#myst_parser.docutils_renderer.DocutilsRenderer.current_node_context">[文档]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">current_node_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Context manager for temporarily setting the current node.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">current_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">current_node</span></div>

    <span class="k">def</span> <span class="nf">render_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;render_</span><span class="si">{</span><span class="n">child</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;render_</span><span class="si">{</span><span class="n">child</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">](</span><span class="n">child</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No render method for: </span><span class="si">{</span><span class="n">child</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="n">token_line</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;render&quot;</span><span class="p">,</span>
                    <span class="n">append_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
                <span class="p">)</span>

<div class="viewcode-block" id="DocutilsRenderer.add_line_and_source_path"><a class="viewcode-back" href="../../api/reference.html#myst_parser.docutils_renderer.DocutilsRenderer.add_line_and_source_path">[文档]</a>    <span class="k">def</span> <span class="nf">add_line_and_source_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Copy the line number and document source path to the docutils node.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">node</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">is_section_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level_to_elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">section</span>

    <span class="k">def</span> <span class="nf">add_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">parent_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">section_level</span>
            <span class="k">for</span> <span class="n">section_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level_to_elem</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">section_level</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">parent_level</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">parent_level</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">level</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_warning</span><span class="p">(</span>
                <span class="s2">&quot;Non-consecutive header level increase; </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">parent_level</span><span class="p">,</span> <span class="n">level</span>
                <span class="p">),</span>
                <span class="n">line</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;header&quot;</span><span class="p">,</span>
                <span class="n">append_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level_to_elem</span><span class="p">[</span><span class="n">parent_level</span><span class="p">]</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_level_to_elem</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span>

        <span class="c1"># Prune level to limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_level_to_elem</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">section_level</span><span class="p">:</span> <span class="n">section</span>
            <span class="k">for</span> <span class="n">section_level</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level_to_elem</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">section_level</span> <span class="o">&lt;=</span> <span class="n">level</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">renderInlineAsText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SyntaxTreeNode</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Special kludge for image `alt` attributes to conform CommonMark spec.</span>

<span class="sd">        Don&#39;t try to use it! Spec requires to show `alt` content with stripped markup,</span>
<span class="sd">        instead of simple escaping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
            <span class="c1"># elif token.type == &quot;image&quot;:</span>
            <span class="c1">#     result += self.renderInlineAsText(token.children)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderInlineAsText</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># ### render methods for commonmark tokens</span>

    <span class="k">def</span> <span class="nf">render_paragraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">render_bullet_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">):</span>
            <span class="c1"># this is used e.g. by tasklist</span>
            <span class="n">list_node</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_ordered_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">enumerated_list</span><span class="p">()</span>
        <span class="n">list_node</span><span class="p">[</span><span class="s2">&quot;enumtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;arabic&quot;</span>
        <span class="n">list_node</span><span class="p">[</span><span class="s2">&quot;suffix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">list_node</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_list_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">item_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">list_item</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">):</span>
            <span class="c1"># this is used e.g. by tasklist</span>
            <span class="n">item_node</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">item_node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">item_node</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_em</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">emphasis</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_softbreak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">render_hardbreak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;br /&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">render_strong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">strong</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_blockquote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">quote</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">block_quote</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_hr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">transition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_code_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_code_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># this should never have a language, since it is just indented text, however,</span>
        <span class="c1"># creating a literal_block with no language will raise a warning in sphinx</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">info</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">language</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">literal_block</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_fence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
        <span class="c1"># Ensure that we&#39;ll have an empty string if info exists but is only spaces</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">info</span> <span class="k">else</span> <span class="n">token</span><span class="o">.</span><span class="n">info</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">info</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;commonmark_only&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">language</span> <span class="o">==</span> <span class="s2">&quot;{eval-rst}&quot;</span><span class="p">:</span>
            <span class="c1"># copy necessary elements (source, line no, env, reporter)</span>
            <span class="n">newdoc</span> <span class="o">=</span> <span class="n">make_document</span><span class="p">()</span>
            <span class="n">newdoc</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
            <span class="n">newdoc</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span>
            <span class="n">newdoc</span><span class="o">.</span><span class="n">reporter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span>
            <span class="c1"># pad the line numbers artificially so they offset with the fence block</span>
            <span class="n">pseudosource</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">))</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
            <span class="c1"># actually parse the rst into our document</span>
            <span class="n">MockRSTParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">pseudosource</span><span class="p">,</span> <span class="n">newdoc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">newdoc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_explicit_target</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">newdoc</span><span class="p">[:])</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;commonmark_only&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">language</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">language</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_directive</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">language</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span><span class="o">.</span><span class="n">temp_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;highlight_language&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highlight_language</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;highlight_language&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">literal_block</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_heading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;match_titles&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_warning</span><span class="p">(</span>
                <span class="s2">&quot;Header nested in this element can lead to unexpected outcomes&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;nested_header&quot;</span><span class="p">,</span>
                <span class="n">append_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Test if we&#39;re replacing a section level first</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_section_level</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">title_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">title_node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

        <span class="n">new_section</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="s2">&quot;myst_update_mathjax&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span><span class="o">.</span><span class="n">config</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">myst_update_mathjax</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">new_section</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;tex2jax_ignore&quot;</span><span class="p">,</span> <span class="s2">&quot;mathjax_ignore&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">new_section</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="n">new_section</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title_node</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">new_section</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">title_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
        <span class="c1"># if self.translate_section_name:</span>
        <span class="c1">#     text = self.translate_section_name(text)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">fully_normalize_name</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">section</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">section</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_implicit_target</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">section</span>

    <span class="k">def</span> <span class="nf">render_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">markup</span> <span class="o">==</span> <span class="s2">&quot;autolink&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_autolink</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="n">ref_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">ref_node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="n">destination</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">attrGet</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;relative-docs&quot;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">destination</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;relative-docs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># make the path relative to an &quot;including&quot; document</span>
            <span class="n">source_dir</span><span class="p">,</span> <span class="n">include_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;relative-docs&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">include_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">destination</span><span class="p">)),</span> <span class="n">source_dir</span>
            <span class="p">)</span>

        <span class="n">ref_node</span><span class="p">[</span><span class="s2">&quot;refuri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">destination</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">attrGet</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">ref_node</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="n">next_node</span> <span class="o">=</span> <span class="n">ref_node</span>

        <span class="c1"># TODO currently any reference with a fragment # is deemed external</span>
        <span class="c1"># (if anchors are not enabled)</span>
        <span class="c1"># This comes from recommonmark, but I am not sure of the rationale for it</span>
        <span class="k">if</span> <span class="n">is_external_url</span><span class="p">(</span>
            <span class="n">destination</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;myst_url_schemes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;heading_anchors&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;myst_extensions&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_node</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">ref_node</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_cross_reference</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_cross_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ignore_missing_refs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reference not found: </span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">),</span>
                <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;ref&quot;</span><span class="p">,</span>
                <span class="n">append_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_autolink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">refuri</span> <span class="o">=</span> <span class="n">target</span> <span class="o">=</span> <span class="n">escapeHtml</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">attrGet</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="n">ref_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">refuri</span><span class="o">=</span><span class="n">refuri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">ref_node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_html_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_html_block</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_html_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node_list</span> <span class="o">=</span> <span class="n">html_to_nodes</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">node_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">image</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">img_node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="n">destination</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">attrGet</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative-images&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_external_url</span><span class="p">(</span>
            <span class="n">destination</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">):</span>
            <span class="c1"># make the path relative to an &quot;including&quot; document</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relative-images&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">destination</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">img_node</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">destination</span>

        <span class="n">img_node</span><span class="p">[</span><span class="s2">&quot;alt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renderInlineAsText</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">attrGet</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">img_node</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">attrGet</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_node</span><span class="p">)</span>

    <span class="c1"># ### render methods for plugin tokens</span>

    <span class="k">def</span> <span class="nf">render_front_matter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pass document front matter data.&quot;&quot;&quot;</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">&quot;not dict&quot;</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="ne">AssertionError</span><span class="p">,</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">ParserError</span><span class="p">,</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">ScannerError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">msg_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Front matter block:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="n">line</span><span class="o">=</span><span class="n">position</span>
                <span class="p">)</span>
                <span class="n">msg_node</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">literal_block</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_node</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="n">substitutions</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;substitutions&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">html_meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;html_meta&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">field_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_to_fm_field_list</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">language_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">language_code</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substitutions</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">fm_substitutions</span> <span class="o">=</span> <span class="n">substitutions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Front-matter &#39;substitutions&#39; is not a dict&quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">position</span>
            <span class="p">)</span>
            <span class="n">msg_node</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">literal_block</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_node</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">html_meta</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">msg_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Front-matter &#39;html_meta&#39; is not a dict&quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">position</span>
            <span class="p">)</span>
            <span class="n">msg_node</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">literal_block</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_node</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">html_meta_to_nodes</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;myst_html_meta&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                    <span class="o">**</span><span class="n">html_meta</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">document</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
                <span class="n">reporter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">dict_to_fm_field_list</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">language_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nodes</span><span class="o">.</span><span class="n">field_list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Render each key/val pair as a docutils ``field_node``.</span>

<span class="sd">        Bibliographic keys below will be parsed as Markdown,</span>
<span class="sd">        all others will be left as literal text.</span>

<span class="sd">        The field list should be at the start of the document,</span>
<span class="sd">        and will then be converted to a `docinfo` node during the</span>
<span class="sd">        `docutils.docutils.transforms.frontmatter.DocInfo` transform (priority 340),</span>
<span class="sd">        and bibliographic keys (or their translation) will be converted to nodes::</span>

<span class="sd">            {&#39;author&#39;: docutils.nodes.author,</span>
<span class="sd">            &#39;authors&#39;: docutils.nodes.authors,</span>
<span class="sd">            &#39;organization&#39;: docutils.nodes.organization,</span>
<span class="sd">            &#39;address&#39;: docutils.nodes.address,</span>
<span class="sd">            &#39;contact&#39;: docutils.nodes.contact,</span>
<span class="sd">            &#39;version&#39;: docutils.nodes.version,</span>
<span class="sd">            &#39;revision&#39;: docutils.nodes.revision,</span>
<span class="sd">            &#39;status&#39;: docutils.nodes.status,</span>
<span class="sd">            &#39;date&#39;: docutils.nodes.date,</span>
<span class="sd">            &#39;copyright&#39;: docutils.nodes.copyright,</span>
<span class="sd">            &#39;dedication&#39;: docutils.nodes.topic,</span>
<span class="sd">            &#39;abstract&#39;: docutils.nodes.topic}</span>

<span class="sd">        Also, the &#39;dedication&#39; and &#39;abstract&#39; will be placed outside the `docinfo`,</span>
<span class="sd">        and so will always be shown in the document.</span>

<span class="sd">        If using sphinx, this `docinfo` node will later be extracted from the AST,</span>
<span class="sd">        by the `DoctreeReadEvent` transform (priority 880),</span>
<span class="sd">        calling `MetadataCollector.process_doc`.</span>
<span class="sd">        In this case keys and values will be converted to strings and stored in</span>
<span class="sd">        `app.env.metadata[app.env.docname]`</span>

<span class="sd">        See</span>
<span class="sd">        https://www.sphinx-doc.org/en/master/usage/restructuredtext/field-lists.html</span>
<span class="sd">        for docinfo fields used by sphinx.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_list</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">field_list</span><span class="p">()</span>

        <span class="n">bibliofields</span> <span class="o">=</span> <span class="n">get_language</span><span class="p">(</span><span class="n">language_code</span><span class="p">)</span><span class="o">.</span><span class="n">bibliographic_fields</span>
        <span class="n">state_machine</span> <span class="o">=</span> <span class="n">MockStateMachine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">MockState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_machine</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bibliofields</span><span class="p">:</span>
                <span class="n">para_nodes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">inline_text</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">body_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">para_nodes</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>

            <span class="n">field_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">field</span><span class="p">()</span>
            <span class="n">field_node</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">field_node</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">field_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
            <span class="n">field_node</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">field_body</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">body_children</span><span class="p">)</span>
            <span class="n">field_list</span> <span class="o">+=</span> <span class="n">field_node</span>

        <span class="k">return</span> <span class="n">field_list</span>

    <span class="k">def</span> <span class="nf">render_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="c1"># markdown-it table always contains two elements:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># with one header row</span>
        <span class="k">assert</span> <span class="n">header</span><span class="o">.</span><span class="n">children</span>
        <span class="n">header_row</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">header_row</span><span class="o">.</span><span class="n">children</span>

        <span class="c1"># top-level element</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;colwidths-auto&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

        <span class="c1"># column settings element</span>
        <span class="n">maxcols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_row</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="n">colwidths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="n">maxcols</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">*</span> <span class="n">maxcols</span>
        <span class="n">tgroup</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">tgroup</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">colwidths</span><span class="p">))</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tgroup</span>
        <span class="k">for</span> <span class="n">colwidth</span> <span class="ow">in</span> <span class="n">colwidths</span><span class="p">:</span>
            <span class="n">colspec</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">colspec</span><span class="p">(</span><span class="n">colwidth</span><span class="o">=</span><span class="n">colwidth</span><span class="p">)</span>
            <span class="n">tgroup</span> <span class="o">+=</span> <span class="n">colspec</span>

        <span class="c1"># header</span>
        <span class="n">thead</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">thead</span><span class="p">()</span>
        <span class="n">tgroup</span> <span class="o">+=</span> <span class="n">thead</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">thead</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_table_row</span><span class="p">(</span><span class="n">header_row</span><span class="p">)</span>

        <span class="c1"># body</span>
        <span class="n">tbody</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">tbody</span><span class="p">()</span>
        <span class="n">tgroup</span> <span class="o">+=</span> <span class="n">tbody</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">tbody</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">body_row</span> <span class="ow">in</span> <span class="n">body</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">render_table_row</span><span class="p">(</span><span class="n">body_row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_table_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">row</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">entry</span><span class="p">()</span>
                <span class="n">para</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">(</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
                <span class="n">style</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attrGet</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">)</span>  <span class="c1"># i.e. the alignment when using e.g. :--</span>
                <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_math_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">markup</span> <span class="o">==</span> <span class="s2">&quot;$$&quot;</span><span class="p">:</span>
            <span class="c1"># available when dmath_double_inline is True</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">math_block</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">nowrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_math_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">math</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_math_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">math_block</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">nowrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_footnote_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Footnote references are added as auto-numbered,</span>
<span class="sd">        .i.e. `[^a]` is read as rST `[#a]_`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>

        <span class="n">refnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">footnote_reference</span><span class="p">(</span><span class="s2">&quot;[^</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">refnode</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">refnode</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_autofootnote_ref</span><span class="p">(</span><span class="n">refnode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">refnode</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="n">refnode</span><span class="p">[</span><span class="s2">&quot;refname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_footnote_ref</span><span class="p">(</span><span class="n">refnode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">refnode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_footnote_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>

        <span class="n">footnote</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">footnote</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">footnote</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="n">footnote</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">footnote</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_autofootnote</span><span class="p">(</span><span class="n">footnote</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">footnote</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_footnote</span><span class="p">(</span><span class="n">footnote</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_explicit_target</span><span class="p">(</span><span class="n">footnote</span><span class="p">,</span> <span class="n">footnote</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">footnote</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_myst_block_break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">block_break</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">block_break</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;block_break&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">block_break</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block_break</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_myst_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">fully_normalize_name</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">target</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_explicit_target</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_myst_line_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">render_myst_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
        <span class="n">rawsource</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:`</span><span class="si">{</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">`&quot;</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">map</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">role_func</span><span class="p">,</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">roles</span><span class="o">.</span><span class="n">role</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_module_rst</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span>
        <span class="p">)</span>
        <span class="n">inliner</span> <span class="o">=</span> <span class="n">MockInliner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">role_func</span><span class="p">:</span>
            <span class="n">nodes</span><span class="p">,</span> <span class="n">messages2</span> <span class="o">=</span> <span class="n">role_func</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rawsource</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">inliner</span><span class="p">)</span>
            <span class="c1"># return nodes, messages + messages2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">+=</span> <span class="n">nodes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Unknown interpreted text role &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">line</span><span class="o">=</span><span class="n">lineno</span>
            <span class="p">)</span>
            <span class="n">problematic</span> <span class="o">=</span> <span class="n">inliner</span><span class="o">.</span><span class="n">problematic</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">rawsource</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">+=</span> <span class="n">problematic</span>

    <span class="k">def</span> <span class="nf">render_colon_fence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Render a code fence with ``:`` colon delimiters.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;:::&quot;</span><span class="p">):</span>
            <span class="c1"># the content starts with a nested fence block,</span>
            <span class="c1"># but must distinguish between ``:options:``, so we add a new line</span>
            <span class="k">assert</span> <span class="n">token</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&quot;colon_fence&quot; must have a `token`&#39;</span>
            <span class="n">linear_token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">linear_token</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">linear_token</span><span class="o">.</span><span class="n">content</span>
            <span class="n">token</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">linear_token</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_fence</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_dl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Render a definition list.&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">definition_list</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="s2">&quot;myst&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">definition_list_item</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">term</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">term</span><span class="p">(</span>
                            <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;dd&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="s2">&quot;Found a definition in a definition list, &quot;</span>
                                <span class="s2">&quot;with no preceding term&quot;</span>
                            <span class="p">),</span>
                            <span class="c1"># nodes.literal_block(content, content),</span>
                            <span class="n">line</span><span class="o">=</span><span class="n">token_line</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">+=</span> <span class="p">[</span><span class="n">error</span><span class="p">]</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                        <span class="n">definition</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">definition</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_line_and_source_path</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node_context</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">render_children</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;Expected a term/definition as a child of a definition list&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;, but found a: </span><span class="si">{</span><span class="n">child</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">),</span>
                        <span class="c1"># nodes.literal_block(content, content),</span>
                        <span class="n">line</span><span class="o">=</span><span class="n">token_line</span><span class="p">(</span><span class="n">child</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">+=</span> <span class="p">[</span><span class="n">error_msg</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">render_directive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Render special fenced code blocks as directives.&quot;&quot;&quot;</span>
        <span class="n">first_line</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">first_line</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">first_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">content</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">nodes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_directive</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">+=</span> <span class="n">nodes_list</span>

    <span class="k">def</span> <span class="nf">run_directive</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">first_line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run a directive and return the generated nodes.</span>

<span class="sd">        :param name: the name of the directive</span>
<span class="sd">        :param first_line: The text on the same line as the directive name.</span>
<span class="sd">            May be an argument or body text, dependent on the directive</span>
<span class="sd">        :param content: All text after the first line. Can include options.</span>
<span class="sd">        :param position: The line number of the first line</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO directive name white/black lists</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_line</span> <span class="o">=</span> <span class="n">position</span>

        <span class="c1"># get directive class</span>
        <span class="n">directive_class</span><span class="p">,</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">directives</span><span class="o">.</span><span class="n">directive</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_module_rst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span>
        <span class="p">)</span>  <span class="c1"># type: (Directive, list)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">directive_class</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Unknown directive type &quot;</span><span class="si">{}</span><span class="s1">&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                <span class="c1"># nodes.literal_block(content, content),</span>
                <span class="n">line</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">error</span><span class="p">]</span> <span class="o">+</span> <span class="n">messages</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">directive_class</span><span class="p">,</span> <span class="n">Include</span><span class="p">):</span>
            <span class="c1"># this is a Markdown only option,</span>
            <span class="c1"># to allow for altering relative image reference links</span>
            <span class="n">directive_class</span><span class="o">.</span><span class="n">option_spec</span><span class="p">[</span><span class="s2">&quot;relative-images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">directives</span><span class="o">.</span><span class="n">flag</span>
            <span class="n">directive_class</span><span class="o">.</span><span class="n">option_spec</span><span class="p">[</span><span class="s2">&quot;relative-docs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">directives</span><span class="o">.</span><span class="n">path</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">arguments</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">body_lines</span> <span class="o">=</span> <span class="n">parse_directive_text</span><span class="p">(</span>
                <span class="n">directive_class</span><span class="p">,</span> <span class="n">first_line</span><span class="p">,</span> <span class="n">content</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">DirectiveParsingError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Directive &#39;</span><span class="si">{}</span><span class="s2">&#39;: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">error</span><span class="p">),</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">literal_block</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">content</span><span class="p">),</span>
                <span class="n">line</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">error</span><span class="p">]</span>

        <span class="c1"># initialise directive</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">directive_class</span><span class="p">,</span> <span class="n">Include</span><span class="p">):</span>
            <span class="n">directive_instance</span> <span class="o">=</span> <span class="n">MockIncludeDirective</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">klass</span><span class="o">=</span><span class="n">directive_class</span><span class="p">,</span>
                <span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="n">body_lines</span><span class="p">,</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state_machine</span> <span class="o">=</span> <span class="n">MockStateMachine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">MockState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_machine</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="n">directive_instance</span> <span class="o">=</span> <span class="n">directive_class</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="c1"># the list of positional arguments</span>
                <span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span><span class="p">,</span>
                <span class="c1"># a dictionary mapping option names to values</span>
                <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                <span class="c1"># the directive content line by line</span>
                <span class="n">content</span><span class="o">=</span><span class="n">StringList</span><span class="p">(</span><span class="n">body_lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]),</span>
                <span class="c1"># the absolute line number of the first line of the directive</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
                <span class="c1"># the line offset of the first line of the content</span>
                <span class="n">content_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># TODO get content offset from `parse_directive_text`</span>
                <span class="c1"># a string containing the entire directive</span>
                <span class="n">block_text</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body_lines</span><span class="p">),</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">state_machine</span><span class="o">=</span><span class="n">state_machine</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># run directive</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">directive_instance</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">DirectiveError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">msg_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">system_message</span><span class="p">(</span>
                <span class="n">error</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">position</span>
            <span class="p">)</span>
            <span class="n">msg_node</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">literal_block</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg_node</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">MockingError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Directive &#39;</span><span class="si">{}</span><span class="s2">&#39; cannot be mocked: </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">exc</span>
                <span class="p">),</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">literal_block</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">content</span><span class="p">),</span>
                <span class="n">line</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">error_msg</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">result</span><span class="p">,</span> <span class="nb">list</span>
        <span class="p">),</span> <span class="s1">&#39;Directive &quot;</span><span class="si">{}</span><span class="s1">&quot; must return a list of nodes.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Node</span>
            <span class="p">),</span> <span class="s1">&#39;Directive &quot;</span><span class="si">{}</span><span class="s1">&quot; returned non-Node object (index </span><span class="si">{}</span><span class="s1">): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">render_substitution_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Render inline substitution {{key}}.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_substitution</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_substitution_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Render block substitution {{key}}.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_substitution</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_substitution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">SyntaxTreeNode</span><span class="p">,</span> <span class="n">inline</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Substitutions are rendered by:</span>

<span class="sd">        1. Combining global substitutions with front-matter substitutions</span>
<span class="sd">           to create a variable context (front-matter takes priority)</span>
<span class="sd">        2. Add the sphinx `env` to the variable context (if available)</span>
<span class="sd">        3. Create the string content with Jinja2 (passing it the variable context)</span>
<span class="sd">        4. If the substitution is inline and not a directive,</span>
<span class="sd">           parse to nodes ignoring block syntaxes (like lists or block-quotes),</span>
<span class="sd">           otherwise parse to nodes with all syntax rules.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">token_line</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="c1"># front-matter substitutions take priority over config ones</span>
        <span class="n">variable_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;myst_substitutions&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="o">**</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;fm_substitutions&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variable_context</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_env</span>

        <span class="c1"># fail on undefined variables</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">undefined</span><span class="o">=</span><span class="n">jinja2</span><span class="o">.</span><span class="n">StrictUndefined</span><span class="p">)</span>

        <span class="c1"># try rendering</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rendered</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{{{</span><span class="si">{</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">}}}}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="n">variable_context</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Substitution error:</span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">+=</span> <span class="p">[</span><span class="n">error_msg</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="c1"># handle circular references</span>
        <span class="n">ast</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{{{</span><span class="si">{</span><span class="n">token</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">}}}}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">references</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">jinja2</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;env&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">sub_references</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="s2">&quot;sub_references&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="n">cyclic</span> <span class="o">=</span> <span class="n">references</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">sub_references</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cyclic</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;circular substitution reference: </span><span class="si">{</span><span class="n">cyclic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">+=</span> <span class="p">[</span><span class="n">error_msg</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="c1"># parse rendered text</span>
        <span class="n">state_machine</span> <span class="o">=</span> <span class="n">MockStateMachine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">MockState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_machine</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>

        <span class="c1"># TODO improve error reporting;</span>
        <span class="c1"># at present, for a multi-line substitution,</span>
        <span class="c1"># an error may point to a line lower than the substitution</span>
        <span class="c1"># should it point to the source of the substitution?</span>
        <span class="c1"># or the error message should at least indicate that its a substitution</span>

        <span class="c1"># we record used references before nested parsing, then remove them after</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">sub_references</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inline</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">REGEX_DIRECTIVE_START</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">rendered</span><span class="p">):</span>
                <span class="n">sub_nodes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">inline_text</span><span class="p">(</span><span class="n">rendered</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">()</span>
                <span class="n">state</span><span class="o">.</span><span class="n">nested_parse</span><span class="p">(</span>
                    <span class="n">StringList</span><span class="p">(</span><span class="n">rendered</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]),</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">base_node</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">sub_nodes</span> <span class="o">=</span> <span class="n">base_node</span><span class="o">.</span><span class="n">children</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">sub_references</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sub_nodes</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_meta_to_nodes"><a class="viewcode-back" href="../../api/reference.html#myst_parser.docutils_renderer.html_meta_to_nodes">[文档]</a><span class="k">def</span> <span class="nf">html_meta_to_nodes</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">document</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reporter</span><span class="p">:</span> <span class="n">Reporter</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">system_message</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Replicate the `meta` directive,</span>
<span class="sd">    by converting a dictionary to a list of pending meta nodes</span>

<span class="sd">    See:</span>
<span class="sd">    https://www.sphinx-doc.org/en/master/usage/restructuredtext/basics.html#html-metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sphinx.addnodes</span> <span class="kn">import</span> <span class="n">meta</span> <span class="k">as</span> <span class="n">meta_cls</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">docutils.parsers.rst.directives.html</span> <span class="kn">import</span> <span class="n">MetaBody</span>

        <span class="n">meta_cls</span> <span class="o">=</span> <span class="n">MetaBody</span><span class="o">.</span><span class="n">meta</span>  <span class="c1"># type: ignore</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">meta_node</span> <span class="o">=</span> <span class="n">meta_cls</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="n">meta_node</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="n">meta_node</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>
        <span class="n">meta_node</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No content&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key_part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
                <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_part</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">meta_node</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_part</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_part</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no &#39;=&#39; in </span><span class="si">{</span><span class="n">key_part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_val</span> <span class="o">=</span> <span class="n">key_part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">attr_name</span> <span class="ow">and</span> <span class="n">attr_val</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;malformed </span><span class="si">{</span><span class="n">key_part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">meta_node</span><span class="p">[</span><span class="n">attr_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">attr_val</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error parsing meta tag attribute &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot;: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">pending</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">pending</span><span class="p">(</span>
            <span class="n">Filter</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;writer&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">meta_node</span><span class="p">]},</span>
        <span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">note_pending</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span></div>
</pre></div>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Executable Book Project<br/>
        
            &copy; Copyright 2020, Executable Book Project.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>